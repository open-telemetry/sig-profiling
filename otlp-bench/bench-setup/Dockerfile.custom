FROM alpine:3.23@sha256:51183f2cfa6320055da30872f211093f9ff1d3cf06f39a0bdb212314c5dc7375 AS certs

RUN apk --update add ca-certificates


FROM golang:1.25@sha256:0ece421d4bb2525b7c0b4cad5791d52be38edf4807582407525ca353a429eccc AS build-stage

WORKDIR /build

COPY ./builder-manifest.yaml builder-manifest.yaml

RUN --mount=type=cache,target=/root/.cache/go-build GO111MODULE=on go install go.opentelemetry.io/collector/cmd/builder@v0.139.0
RUN --mount=type=cache,target=/root/.cache/go-build builder --config builder-manifest.yaml


FROM alpine:3.23@sha256:51183f2cfa6320055da30872f211093f9ff1d3cf06f39a0bdb212314c5dc7375

RUN apk --no-cache add ca-certificates util-linux

ARG USER_UID=10001
RUN adduser -D -u ${USER_UID} otel
USER ${USER_UID}

COPY --chmod=755 --from=build-stage /build/dist/otelcol-ebpf-profiler-custom /otelcol/otelcol-ebpf-profiler-custom

ENTRYPOINT ["/otelcol/otelcol-ebpf-profiler-custom"]
CMD ["--config", "/conf/relay.yaml"]

EXPOSE 4317 4318 13133 14250 14268 6831 9411
